# A check that ensures that `tket-py` works correctly with the latest release of `tket-exts` and `tket-eccs`.
#
# If this fails, it is likely that we either didn't update the dependency version in tket's pyproject,
# or the latest `tket-exts`/`tket-eccs` packages haven't been published to pypi.

name: ðŸšš Release Checks

on:
  pull_request:
    branches:
      - main
  workflow_dispatch: {}

env:
  SCCACHE_GHA_ENABLED: "true"
  RUSTC_WRAPPER: "sccache"
  # Pinned version for the uv package manager
  UV_VERSION: "0.9.7"

  # Path to the cached tket-c-api library
  # When this envvar is set, the `./.github/actions/tket-c-api` action **must** be run to fetch the artifacts
  # This config is not required, but speeds up the build by caching the tket-c-api library
  # The alternative is to install conan and remove the env var
  TKET_C_API_PATH: "${{ github.workspace }}/tket-c-api"
  LD_LIBRARY_PATH: ${{ github.workspace }}/tket-c-api/lib

jobs:
  py-release:
    name: Check `tket-py`compatibility with ${{ matrix.target.resolution }} dependencies
    runs-on: ubuntu-latest
    # Check if we are running on a release PR.
    #
    # release-please always uses this branch name.
    if: ${{ github.event_name == 'workflow_dispatch' || github.head_ref == 'release-please--branches--main--components--tket-py' }}
    strategy:
      fail-fast: false
      matrix:
        target:
          - resolution: "highest"
            python: "3.14"
          - resolution: "lowest-direct"
            python: "3.10"
    steps:
      - uses: actions/checkout@v5
      - uses: mozilla-actions/sccache-action@v0.0.9
      - name: Install tket-c-api library
        uses: ./.github/actions/tket-c-api
        with:
          install-path: ${{ env.TKET_C_API_PATH }}
          target: x86_64-unknown-linux-gnu
          compatibility: manylinux_2_28
      - name: Set up uv
        uses: astral-sh/setup-uv@v7
        with:
          version: ${{ env.UV_VERSION }}
          enable-cache: true
      - name: Install Python ${{ matrix.target.python }}
        run: |
          uv python install ${{ matrix.target.python }}
          uv python pin ${{ matrix.target.python }}
      - name: Setup `tket-py` with only pypi deps
        env:
          UV_RESOLUTION: ${{ matrix.target.resolution }}
        run: |
          uv lock --no-sources -U
          uv sync --no-sources --no-install-workspace
          uv pip install --no-sources tket-exts
          uv pip install --no-sources tket-eccs
          uv run --no-sync maturin develop
          echo "\nDone! Installed dependencies:"
          uv pip list
      - name: Type check with mypy
        run: uv run --no-sync mypy tket-py
      - name: Lint with ruff
        run: uv run --no-sync ruff check tket-py
      - name: Run python tests
        run: uv run --no-sync pytest tket-py
