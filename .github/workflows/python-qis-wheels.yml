name: Python wheels ðŸ (qis-compiler)

on:
  push:
    branches:
      - main
  release:
    types:
      - published
  pull_request:
    # check builds work if qis-compiler build config changes
    paths:
      - "qis-compiler/pyproject.toml"
      - ".github/workflows/python-qis-wheels.yml"
  workflow_dispatch:

permissions:
  contents: write
  id-token: write

env:
  CARGO_TERM_COLOR: always
  CACHE_CARGO: true
  UV_VERSION: "0.9.7"
jobs:
  # Check if the tag matches the package name,
  # or if the workflow is running on a non-release event.
  check-tag:
    name: Check tag
    runs-on: ubuntu-latest
    outputs:
      run: ${{ steps.check-tag.outputs.run }}
    steps:
      - name: Check tag
        id: check-tag
        run: |
          echo "run=$SHOULD_RUN" >> $GITHUB_OUTPUT
        env:
          SHOULD_RUN: ${{ github.event_name != 'release' || ( github.ref_type == 'tag' && startsWith(github.ref, 'refs/tags/qis-compiler-v') ) }}

  build_qis_compiler_wheels:
    needs: check-tag
    if: ${{ needs.check-tag.outputs.run == 'true' }}
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-latest
          - ubuntu-24.04-arm
          - macos-15
          - macos-15-intel
          - windows-2022
    name: "qis-compiler wheels (${{matrix.os}})"
    runs-on: ${{ matrix.os }}
    steps:
      # ---------------------------------
      # Bootstrap the build environment
      # ---------------------------------

      - uses: actions/checkout@v5
        with:
          submodules: recursive

      - name: Set up UV
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true
          version: ${{ env.UV_VERSION }}

      # Note that we are using CIBuildWheel to build the wheels.
      # This treats linux differently to macos and windows.
      #
      # On linux, building on the host platform adds an implicit
      # requirement on the host platform's glibc version and other
      # system libraries that happen to be available. To mitigate
      # this, builds are performed within a docker container that
      # is compatible with manylinux (in our case, manylinux_2_28).
      #
      # See https://github.com/pypa/manylinux for more information
      # about the manylinux project.
      #
      # This is an important aspect of wheel building, as it means
      # that wheels are built in an isolated environment. We use
      # /tmp/ci-cache for caching, which is then accessed as
      # /host/tmp/ci-cache within the container.

      # if the hugr_qis compiler has changed, we build it.
      - name: Build selene-hugr-qis-compiler wheel
        uses: pypa/cibuildwheel@v3.2.1
        with:
          package-dir: qis-compiler

      - name: Check built wheels
        run: uvx twine check --strict wheelhouse/*.whl

      - name: Upload wheels
        uses: actions/upload-artifact@v5
        with:
          name: qis-compiler-wheels-${{ matrix.os }}
          path: wheelhouse/*.whl
          if-no-files-found: error

  release:
    name: Release qis-compiler
    needs: [check-tag, build_qis_compiler_wheels]
    if: ${{ needs.check-tag.outputs.run == 'true' && github.event_name == 'pull_request' }}
    runs-on: ubuntu-latest
    # always do a full build and test before release of any package
    environment: release
    permissions:
      contents: write
      # IMPORTANT: this permission is mandatory for trusted publishing
      id-token: write
    steps:
      - uses: actions/download-artifact@v5
        with:
          path: wheelhouse
          merge-multiple: true

      - name: Publish package distributions to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          verbose: true
          skip-existing: true
          packages-dir: wheelhouse
