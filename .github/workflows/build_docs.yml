name: Build and publish docs

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - '**'
  workflow_dispatch: {}

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
    test:
      name: Test sphinx docs build
      runs-on: ubuntu-latest
      env:
          UV_FROZEN: 1
      steps:
        - uses: actions/checkout@v4
          with:
            submodules: true

        - uses: extractions/setup-just@v3
          with:
            just-version: '1.40.0'

        - name: Install uv
          uses: astral-sh/setup-uv@v5
          with:
              enable-cache: true
              version: "0.6.6"

        - name: Run the docs build
          run: |
            just build-pydocs

        - name: Upload artifact.
          uses: actions/upload-pages-artifact@v3
          with:
            path: ./tket-py/docs/build

            
    publish:
      name: Publish docs.
      environment:
          name: github-pages
          url: ${{ steps.deployment.outputs.page_url }}
      runs-on: ubuntu-latest
      needs: test
      steps:
        - name: Setup Pages
          uses: actions/configure-pages@v5
        - name: Deploy to GitHub Pages.
          id: deployment
          uses: actions/deploy-pages@v4